#!pip install numpy bokeh

import numpy as np
from bokeh.plotting import figure, show, output_notebook
from bokeh.layouts import gridplot

output_notebook()

def radial_kernel(x0, X, tau):
    
    X = X.reshape(-1, 1)
    x0 = np.array([x0]).reshape(1, -1)
    return np.exp(np.sum((X - x0) ** 2, axis=1) / (-2 * tau * tau))


def local_regression(x0, X, Y, tau):
    
    X = X.reshape(-1, 1)
    x0 = np.array([1, x0])       
    X_b = np.c_[np.ones(len(X)), X]

    
    weights = np.diag(radial_kernel(x0[1], X.flatten(), tau))

    
    beta = np.linalg.pinv(X_b.T @ weights @ X_b) @ (X_b.T @ weights @ Y)

    
    return x0 @ beta


n = 1000
X = np.linspace(-3, 3, num=n)
Y = np.log(np.abs(X ** 2 - 1) + 0.5)


X += np.random.normal(scale=0.1, size=n)

domain = np.linspace(-3, 3, num=300)


def plot_lwr(tau):
    predictions = np.array([local_regression(x0, X, Y, tau) for x0 in domain])

    p = figure(width=400, height=400, title=f"Locally Weighted Regression (Ï„ = {tau})")
    p.scatter(X, Y, alpha=0.3, size=3, color="navy", legend_label="Data")
    p.line(domain, predictions, line_width=2, color="red", legend_label="LWR Fit")
    p.legend.location = "top_left"
    p.xaxis.axis_label = "X"
    p.yaxis.axis_label = "Y"
    return p


grid = gridplot([
    [plot_lwr(10.0), plot_lwr(1.0)],
    [plot_lwr(0.1), plot_lwr(0.01)]
])

show(grid)
