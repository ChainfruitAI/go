# !pip install scikit-learn pgmpy matplotlib seaborn pandas numpy
!pip install --upgrade scipy
!pip install --upgrade statsmodels

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from pgmpy.models import DiscreteBayesianNetwork
from pgmpy.estimators import MaximumLikelihoodEstimator
from pgmpy.inference import VariableElimination
from sklearn.metrics import accuracy_score, confusion_matrix
from sklearn.model_selection import train_test_split

names = [
    'age', 'sex', 'cp', 'trestbps', 'chol', 'fbs',
    'restecg', 'thalach', 'exang', 'oldpeak', 'slope',
    'ca', 'thal', 'heartdisease'
]


file_path = r"heart.csv"

heartDisease = pd.read_csv(file_path, names=names)

heartDisease = heartDisease.replace('?', np.nan)

for col in heartDisease.columns:
    heartDisease[col] = pd.to_numeric(heartDisease[col], errors='coerce')

heartDisease.dropna(inplace=True)

heartDisease = heartDisease.astype(int)

X = heartDisease.drop('heartdisease', axis=1)
y = heartDisease['heartdisease']


X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42
)

model = DiscreteBayesianNetwork([
    ('age', 'trestbps'),
    ('age', 'fbs'),
    ('sex', 'trestbps'),
    ('exang', 'trestbps'),
    ('cp', 'heartdisease'),
    ('trestbps', 'heartdisease'),
    ('chol', 'heartdisease'),  # Keep: chol -> heartdisease
    ('oldpeak', 'heartdisease'),
    ('heartdisease', 'restecg'),
    ('heartdisease', 'thalach'),
    ('heartdisease', 'slope'),
    ('heartdisease', 'ca'),
    ('heartdisease', 'thal')
])

model.fit(heartDisease, estimator=MaximumLikelihoodEstimator)

HeartDisease_infer = VariableElimination(model)

y_pred = []
for idx in range(X_test.shape[0]):
    sample = X_test.iloc[idx].to_dict()
    
    sample.pop('heartdisease', None) 
    
    query_result = HeartDisease_infer.query(
        variables=['heartdisease'],
        evidence=sample,
        show_progress=False
    )
    pred = query_result.values.argmax()
    y_pred.append(pred)

accuracy = accuracy_score(y_test, y_pred)
conf_matrix = confusion_matrix(y_test, y_pred)

print(f"\nAccuracy: {accuracy:.4f}")
print("\nConfusion Matrix:\n", conf_matrix)


plt.figure(figsize=(6, 5))
sns.heatmap(conf_matrix, annot=True, fmt='d', cmap='Blues',
            xticklabels=['No Disease', 'Disease'],
            yticklabels=['No Disease', 'Disease'])
plt.title('Confusion Matrix - Bayesian Network')
plt.xlabel('Predicted')
plt.ylabel('Actual')
plt.show()

q = HeartDisease_infer.query(variables=['heartdisease'],
                              evidence={'age': 37, 'sex': 0},
                              show_progress=False)
print("\nSample Query Result for age=37, sex=0:")
print(q)
